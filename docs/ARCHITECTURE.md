# Ulanzi 灯光类目分类系统 - 架构文档

## 1. 系统概述

### 1.1 项目背景
跨境电商日本站点的灯光类商品类目自动分类系统，将亚马逊原始类目映射到公司标准11个三级类目。

### 1.2 核心目标
- 建立可运行的分类框架
- 准确率达到 80% 以上
- 支持参数调优和规则配置可视化

### 1.3 业务约束
- 无训练集/验证集（原始类目非人工标签）
- 人工后续核验标签正确性
- 框架优先，参数调优为后续工作

---

## 2. 技术架构

### 2.1 技术栈

| 层级 | 技术选型 |
|------|---------|
| 前端框架 | Streamlit |
| 后端逻辑 | Python 3.10+ |
| 数据库 | SQLite |
| 配置格式 | JSON |
| 可视化 | Plotly |

### 2.2 项目结构

```
Ulanzi_category_mapping/
├── config/                    # 配置文件目录
│   ├── signals.json          # 多语言信号词典（布尔特征）
│   ├── scoring_models.json   # 品类评分权重模型
│   └── hard_filters.json    # 硬拦截规则
├── frontend/                 # Streamlit 前端
│   ├── app.py              # 主程序入口
│   ├── components/         # 可复用组件
│   │   ├── charts.py      # 可视化图表
│   │   └── log_viewer.py  # 日志查看器
│   ├── pages/             # 页面模块
│   │   ├── rules_overview.py    # 规则概览
│   │   ├── classification_test.py # 分类测试
│   │   ├── data_audit.py        # 数据审核
│   │   └── rule_config.py       # 规则配置
│   └── utils/             # 工具模块
│       ├── classifier.py   # 分类服务
│       ├── rules_loader.py # 规则加载器
│       ├── database.py    # 数据库管理
│       └── error_handler.py # 错误处理
├── src/                    # 核心分类引擎
│   ├── classifier.py      # 分类器核心
│   └── utils.py          # 工具函数
├── tests/                 # 测试用例
├── docs/                  # 文档
└── data/                  # 数据目录
```

---

## 3. 分类引擎架构（五层解耦）

### 3.1 数据流图

```
输入: 商品标题 (SKU标题)
  ↓
第一层: 文本预处理 (标准化、全角→半角)
  ↓
第二层: 布尔特征感知 (关键词匹配 → 0/1)
  ↓
第三层: 规格数值归一化 (功率、照度等 → [0,1])
  ↓
第四层: 向量化评分 (点积公式 → 各品类得分)
  ↓
第五层: 冲突裁决 (硬规则 → 最终分类)
  ↓
输出: 公司标准三级类目
```

### 3.2 各层详解

#### 第一层：文本预处理
**功能**：将原始商品标题处理为统一的干净文本

**处理逻辑**：
1. 全角→半角转换（日语商品标题常见全角字符）
2. 大小写归一化（统一小写）
3. 噪声去除（保留字母、数字、连字符、空格）
4. 不翻译（直接处理原语言）

**输出**：`clean_title`

#### 第二层：布尔特征感知
**功能**：通过关键词匹配，将标题转换为布尔特征向量

**特征分类**：
| 特征类型 | 示例 | 作用 |
|---------|------|------|
| 产品形态 | tag_is_ring, tag_is_tube, tag_is_panel | 强形态信号 |
| 产品类型 | tag_is_flash, tag_is_cob, tag_is_inflatable | 核心品类信号 |
| 接口规格 | tag_has_bowens, tag_has_magnetic | 区分专业/便携 |
| 配套部件 | tag_has_stand, tag_has_phone_clip | 辅助判断场景 |
| 技术指标 | tag_has_ttl, tag_has_hss, tag_has_rgb | 辅助区分 |

**多语言支持**：
- 每个 tag 配置 CN/US/JP 三套关键词
- 同一功能的多语言词映射到同一 tag

**示例**：`tag_is_ring`
```json
{
  "CN": ["环形", "圆环"],
  "US": ["ring light", "ring"],
  "JP": ["リングライト", "リング ライト", "女優ライト"]
}
```

**输出**：布尔特征向量 `{tag_is_ring: 1, tag_has_bowens: 0, ...}`

#### 第三层：规格数值归一化
**功能**：将技术参数提取并归一化到 [0, 1] 区间

**提取的规格参数**：
| 参数 | 提取模式 | 归一化阈值 | 公式 | 业务意义 |
|------|---------|-----------|------|---------|
| f_wattage | 120W, 120w, 120ワット | 300W | min(watt/300, 1) | 区分大功率vs便携 |
| f_lux | 5000 lux, 5000ルクス | 20000 lux | min(lux/20000, 1) | 照度专业度 |
| f_kelvin | 5600K, 5600ケルビン | 10000K | min(kelvin/10000, 1) | 色温参数 |
| f_cri | CRI:96, CRI 96 | 100 | cri/100 | 显色性指标 |

**输出**：数值特征向量 `{f_wattage: 0.4, f_lux: 0.25, ...}`

#### 第四层：向量化评分引擎
**数学原理**：
```
Score(品类i) = BaseScore(i) + Σ(特征值 × 权重)
```

**品类配置示例**：
| 品类 | 基础分 | 关键正权重 | 关键负权重 |
|------|--------|-----------|-----------|
| COB补光灯 | 50 | tag_has_bowens: 80, tag_is_cob: 60 | tag_is_ring: -150 |
| 环形灯 | 60 | tag_is_ring: 150 | tag_has_bowens: -200 |
| 运动相机补光灯 | 40 | tag_has_magnetic: 60 | tag_has_bowens: -200 |

**工作流程**：
1. 合并第一、二、三层特征为完整向量
2. 对 11 个品类并行计算得分
3. 无先后顺序问题（解决 SQL "先到先得" 问题）

**负权重作用**：
- 解决参数权重过载问题
- 即使功率高，形态不对也会被负权重抵消

**输出**：11 个品类的得分字典

#### 第五层：冲突裁决层
**功能**：通过硬规则解决边界情况

**裁决规则优先级（从高到低）**：
| 规则 | 触发条件 | 输出 | 业务场景 |
|------|---------|------|---------|
| 1. 配件拦截 | 标题包含"柔光箱"、"diffuser"等 | 灯光类-其他 | 配件不属于核心品类 |
| 2. 形态锁定 | tag_is_ring=1 或 tag_is_inflatable=1 | 强制归为对应品类 | 形态明确无需打分 |
| 3. 最低分过滤 | 最高得分 < 30 | 灯光类-其他 | 任何品类都不匹配 |
| 4. 最高分归档 | - | 得分最高的品类 | 常规情况 |

**输出**：最终分类结果 `{predicted_category, decision_reason}`

---

## 4. 数据流

### 4.1 分类流程数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                        输入层                                    │
│  SKU标题: "Godox AD300Pro 300W TTL HSS ストロボ"               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     第一层: 文本预处理                           │
│  clean_title: "godox ad300pro 300w ttl hss strobo"             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     第二层: 布尔特征                             │
│  {tag_is_flash: 1, tag_has_ttl: 1, tag_has_hss: 1, ...}        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     第三层: 数值特征                             │
│  {f_wattage: 1.0, f_lux: 0, f_kelvin: 0, f_cri: 0}            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     第四层: 向量化评分                           │
│  {闪光灯: 350, COB补光灯: 180, 平板灯: 100, ...}               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     第五层: 冲突裁决                             │
│  predicted_category: "闪光灯"                                    │
│  decision_reason: "高分归档"                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 数据库存储

#### 分类结果表
| 字段 | 说明 |
|------|------|
| sku_id | SKU 唯一标识 |
| sku_title | 原始标题 |
| site | 站点 (JP/US/CN) |
| clean_title | 清洗后标题 |
| predicted_category | 预测分类 |
| decision_reason | 裁决原因 |
| scores_all | 所有品类得分 |
| features_bool | 布尔特征 |
| features_num | 数值特征 |

---

## 5. 配置说明

### 5.1 信号词典 (config/signals.json)

```json
{
  "tag_is_flash": {
    "CN": ["闪光灯", "闪灯"],
    "US": ["flash", "strobe", "speedlite"],
    "JP": ["フラッシュ", "ストロボ", "スピードライト"]
  },
  "tag_is_ring": {
    "CN": ["环形", "圆环"],
    "US": ["ring light", "ring"],
    "JP": ["リングライト", "リング ライト", "女優ライト"]
  }
}
```

### 5.2 评分模型 (config/scoring_models.json)

```json
{
  "COB补光灯": {
    "base_score": 50,
    "weights": {
      "tag_has_bowens": 80,
      "tag_is_cob": 60,
      "f_wattage": 50,
      "tag_is_ring": -150,
      "tag_is_tube": -120
    }
  },
  "环形灯": {
    "base_score": 60,
    "weights": {
      "tag_is_ring": 150,
      "tag_has_bowens": -200,
      "tag_is_panel": -150
    }
  }
}
```

### 5.3 硬拦截规则 (config/hard_filters.json)

```json
{
  "accessories": [
    "softbox", "柔光箱", "ディフューザー",
    "diffuser", "reflector", "リフレクター"
  ],
  "form_factor_lock": {
    "tag_is_ring": "环形灯",
    "tag_is_inflatable": "充气灯"
  },
  "min_score_threshold": 30
}
```

---

## 6. 前端功能模块

### 6.1 规则概览
- 展示 11 个品类的分类规则仪表盘
- 显示权重分布柱状图
- 支持搜索和筛选

### 6.2 分类测试
- 输入商品标题进行实时分类
- 展示得分排行榜图表
- 显示特征匹配和得分明细

### 6.3 数据审核
- 批量上传 CSV/Excel 文件
- 查看/修正分类结果
- 筛选和分页浏览

### 6.4 规则配置
- 可视化编辑信号词典
- 可视化编辑评分模型
- 追踪配置变更历史

---

## 7. 部署指南

### 7.1 环境要求
- Python 3.10+
- Streamlit
- Plotly
- Pandas

### 7.2 安装依赖
```bash
pip install -r requirements.txt
```

### 7.3 运行前端
```bash
cd Ulanzi_category_mapping
python -m streamlit run frontend/app.py --server.headless true
```

### 7.4 运行测试
```bash
python -m pytest tests/ -v
```

---

## 8. 后续调优方向

### 8.1 权重调优
1. 调整 scoring_models.json 中的权重值
2. 基于人工核验结果增加/减少特征权重
3. 新增特征并配置权重

### 8.2 关键词扩充
1. 根据人工核验添加新关键词到 signals.json
2. 新增品牌词（godox, canon, nissin 等）
3. 新增型号模式（ad\d+pro, v\d+ 等）

### 8.3 硬拦截规则扩展
1. 发现系统性误判后添加新拦截规则
2. 扩充配件词列表

---

## 9. 变更日志

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0.0 | 2026-02-09 | 初始版本 |
| 1.1.0 | 2026-02-11 | 添加可视化图表、错误处理、日志功能 |

---

## 10. 关键文件索引

| 文件路径 | 用途 | 可否修改 |
|---------|------|---------|
| config/signals.json | 多语言关键词词典 | ✅ 可配置 |
| config/scoring_models.json | 品类权重向量 | ✅ 可配置 |
| config/hard_filters.json | 硬拦截规则 | ✅ 可配置 |
| frontend/components/charts.py | 可视化图表组件 | ✅ 可扩展 |
| frontend/utils/error_handler.py | 错误处理和日志 | ✅ 可扩展 |
| frontend/components/log_viewer.py | 日志查看器组件 | ✅ 可扩展 |
| src/classifier.py | 分类器核心逻辑 | ❌ 不建议 |
| src/utils.py | 工具函数 | ❌ 不建议 |
| main.py | 主程序入口 | ❌ 不建议 |
| frontend/app.py | 前端入口 | ❌ 不建议 |

---

**文档版本**: 1.1.0
**更新日期**: 2026-02-11
