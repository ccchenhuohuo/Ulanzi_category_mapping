# 日本灯光类脚本重构项目 - 完整文档

**文档版本**: 1.0.0
**创建日期**: 2026-02-09
**项目位置**: `/Users/chenyu/test/`

---

## 目录

1. [项目背景](#项目背景)
2. [数据探查结果](#数据探查结果)
3. [问题分析](#问题分析)
4. [解决方案概述](#解决方案概述)
5. [公司标准类目映射](#公司标准类目映射)
6. [技术架构](#技术架构)
7. [实施计划](#实施计划)
8. [配置文件说明](#配置文件说明)
9. [快速开始](#快速开始)
10. [后续调优方向](#后续调优方向)

---

## 项目背景

### 业务场景
跨境电商日本站点的灯光类商品类目映射，当前使用SQL脚本进行分类。

### 核心目标
建立可运行、可调优的分类框架，将准确率从约50%提升至更高水平。

### 关键约束
1. **无训练集/验证集**：原数据中的日文/中文子类目是亚马逊口径，非人工标签
2. **人工后续核验**：标签正确性由人工后续核实
3. **框架优先**：当前重点是搭建框架，参数调优是后续工作

---

## 数据探查结果

### 数据概况

| 项目 | 数值 |
|------|------|
| 总数据量 | 387,722 条 |
| 数据来源 | Amazon JP站点 |
| 数据文件 | `日本灯光类.csv` (约374MB) |

### 数据列结构

```
产品标题(中文), SKU标题, platform, site, product_id, sku_id, 产品标题,
产品URL, 产品图片, category_1, category_2, category_3, category_4,
category_5, category_id, 类目名称, 子类目(中文), 子类目,
一级类目(中文), 二级类目(中文), 三级类目(中文), 四级类目(中文),
五级类目(中文), brand_name, std_brand_name, shop_id, shop_name,
manufacturer, media, count, discount_price, discount_sales,
page_price, page_sales, product_listing_time, month_dt
```

**关键列说明**：
- `SKU标题`：日文商品标题，分类的核心依据
- `类目名称`：亚马逊原始子类目（日语），**不是人工标签**
- `三级类目(中文)`：亚马逊类目的中文翻译，**不是人工标签**
- `std_brand_name`：标准化品牌名

### 亚马逊原始类目分布

| 类目名称（日语） | 数量 | 占比 | 含义 |
|-----------------|------|------|------|
| フラッシュ・ストロボ | 135,059 | 34.8% | 闪光灯/频闪灯 |
| 定常光ライト | 114,716 | 29.6% | 连续光（摄影棚设备） |
| 自撮りライト | 101,016 | 26.1% | 自拍灯（手机配件） |
| オンカメラビデオライト | 16,144 | 4.2% | 机顶视频灯（配件） |
| 外付けフラッシュ | 10,930 | 2.8% | 外接闪光灯 |
| モノブロックストロボ | 4,816 | 1.2% | 单体闪光灯 |
| ストロボ・フラッシュ | 4,004 | 1.0% | 闪光灯/闪光 |
| 照明・撮影ライト | 652 | 0.2% | 照明/拍摄灯 |
| リモートフラッシュユニット | 216 | 0.1% | 遥控闪光单元 |
| 水中ライト・ストロボ | 148 | 0.0% | 水下灯/闪光灯 |
| スマートフォン用リングライト | 21 | 0.0% | 智能手机用环形灯 |

### 三级类目(中文)分布（亚马逊口径）

| 类目 | 数据量 | 占比 |
|------|--------|------|
| 闪光灯/频闪灯 | 135,059 | 34.8% |
| 摄影棚摄影设备 | 114,614 | 29.6% |
| 手机和智能手机配件 | 111,967 | 28.9% |
| 配件 | 16,144 | 4.2% |
| 水下摄影设备 | 9,938 | 2.6% |

### 品牌分布（Top 10）

| 品牌名 | 数量 |
|--------|------|
| OTHERS/其他 | 70,983 |
| GODOX/神牛 | 15,162 |
| NEEWER/纽尔 | 3,913 |
| LS/零笙 | 3,568 |
| APUTURE/爱图仕 | 2,726 |
| BUZHI | 2,582 |
| Acogedor | 2,465 |
| VBESTLIFE | 2,325 |
| WF/伟峰 | 1,994 |
| Worpo | 1,864 |

### 关键词频率分析

#### 全局高频词（Top 30）

| 关键词 | 频次 | 说明 |
|--------|------|------|
| led | 51,698 | LED光源 |
| ライト | 34,308 | 灯光（日语） |
| godox | 19,808 | 神牛品牌 |
| 自撮りライト | 19,550 | 自拍灯 |
| リングライト | 19,153 | 环形灯 |
| 自撮り | 17,146 | 自拍 |
| 充電式 | 16,703 | 充电式 |
| メイク | 14,713 | 化妆 |
| カメラ | 14,553 | 相机 |
| 動画撮影 | 13,637 | 视频拍摄 |
| ライブ配信 | 13,609 | 直播配信 |
| ポータブル | 13,267 | 便携 |
| vlog | 12,572 | 视频博客 |
| ビデオライト | 12,039 | 视频灯 |
| light | 11,607 | 灯光（英语） |
| ledビデオライト | 10,432 | LED视频灯 |
| 撮影用ライト | 9,989 | 拍摄用灯 |
| 調光可能 | 9,912 | 可调光 |
| 会議 | 9,643 | 会议 |
| rgb | 9,611 | RGB（彩色） |
| 写真撮影 | 9,288 | 拍照 |
| 撮影 | 8,510 | 拍摄 |
| スマホ | 8,491 | 智能手机 |
| ビデオ | 8,245 | 视频 |
| フラッシュ | 8,092 | 闪光灯 |
| youtube | 7,885 | YouTube |
| ledリングライト | 7,650 | LED环形灯 |
| 照明 | 7,560 | 照明 |
| 旅行 | 7,494 | 旅行 |
| フィルライト | 7,373 | 补光灯 |

#### 按类目分词高频词

**闪光灯/频闪灯** (135,059条)
- godox: 16,332
- フラッシュ: 7,377
- ttl: 6,501
- hss: 4,981
- スピードライト: 4,942
- 8000s: 4,077
- canon: 4,014
- 4g: 4,011
- v1: 3,620
- ad300pro: 3,565
- sony: 3,403
- ad200pro: 3,399
- nikon: 3,386
- v1c: 3,243
- v1n: 3,182
- tt685: 3,041

**摄影棚摄影设备** (114,614条)
- led: 24,464
- ライト: 13,261
- ledビデオライト: 7,907
- ビデオライト: 7,667
- rgb: 7,554
- cri: 4,560
- リングライト: 4,551
- ポータブル: 4,470
- 調光可能: 4,386
- 生放送: 4,344

**手机和智能手机配件** (111,967条)
- led: 16,527
- 自撮りライト: 15,844
- ライト: 15,317
- メイク: 13,689
- 充電式: 13,410
- リングライト: 13,194
- 自撮り: 12,586
- ライブ配信: 11,976
- 動画撮影: 11,279
- 会議: 8,815

**配件** (16,144条)
- led: 3,896
- 色温度調整可能: 1,841
- 長持ちする充電式バッテリー: 1,633
- 70個のled付きポータブルrgbビデオライト: 1,465
- ビデオライト: 1,390
- フィルライト: 1,018

**水下摄影设备** (9,938条)
- led: 3,241
- ライト: 2,360
- ボート: 1,845
- 防水: 1,748
- ストロボ: 1,517
- カヤック: 1,291

---

## 问题分析

### 原SQL脚本问题

当前SQL脚本（见 `export.sql`）存在以下系统性问题：

1. **参数权重过载**
   - 瓦数/Lux数值优先级高于形态词
   - 案例：Pano 120c因120W被误判为COB

2. **形态拦截失效**
   - 缺乏"互斥特征"的负向扣分机制
   - 案例：环形灯+高功率被误判为COB

3. **语言Bias**
   - 日语/英语关键词权重不均衡

4. **多品类竞争**
   - 依赖SQL执行顺序的"先到先得"逻辑
   - 关键词库仅89个，覆盖不足

### SQL关键词库分析

原SQL脚本仅有**89个关键词**，但数据中大量高频词未被覆盖：

| 关键词类型 | 示例 | 数据频次 | SQL覆盖情况 |
|-----------|------|---------|-------------|
| 品牌词 | godox | 19,808 | ❌ 未覆盖 |
| 品牌词 | canon | 4,014 | ❌ 未覆盖 |
| 型号 | ad300pro | 3,565 | ❌ 未覆盖 |
| 型号 | v1 | 3,620 | ❌ 未覆盖 |
| 型号 | v1c | 3,243 | ❌ 未覆盖 |
| 型号 | tt685 | 3,041 | ❌ 未覆盖 |
| 技术参数 | cri | 4,560 | ✅ 已覆盖 |
| 技术参数 | rgb | 9,611 | ❌ 未覆盖 |
| 形态词 | 自撮りライト | 19,550 | ✅ 已覆盖 |
| 形态词 | 充電式 | 16,703 | ❌ 未覆盖 |

### 典型误判案例

| 商品标题 | 当前问题 | 预期分类 |
|---------|---------|---------|
| amaran Pano 120c 120W RGBWW パネルライト | 因120W被误判为COB | 平板灯 |
| Godox AD300Pro 300W ストロボ TTL HSS | 因300W被误判为COB | 闪光灯 |
| Aputure MT Pro 60cm RGBWW チューブライト | 被误判为手机便携补光灯 | 棒灯 |
| NiceVeedi Ring Light 10inch | 被误判为手机便携补光灯 | 环形灯 |

---

## 解决方案概述

### 五层解耦向量化分类引擎

采用分层解耦架构，将复杂的分类逻辑分解为5个清晰层次：

```
输入: 商品标题 (SKU标题)
  ↓
第一层: 文本预处理 (标准化、全角→半角)
  ↓
第二层: 布尔特征感知 (关键词匹配 → 0/1)
  ↓
第三层: 规格数值归一化 (功率、照度等 → [0,1])
  ↓
第四层: 向量化评分 (点积公式 → 各品类得分)
  ↓
第五层: 冲突裁决 (硬规则 → 最终分类)
  ↓
输出: 公司标准三级类目
```

### 核心改进

| 维度 | SQL方案 | 向量化方案 |
|------|---------|-----------|
| 特征提取 | 简单关键词匹配 | 多维度特征（布尔+数值） |
| 评分机制 | CASE WHEN顺序执行 | 并行点积计算 |
| 负权重 | 无（难以实现） | 有（形态互斥） |
| 语言支持 | 固定89词 | 可配置多语言词典 |
| 调优方式 | 修改SQL代码 | 修改JSON配置 |

---

## 公司标准类目映射

根据 `CMI_EC公司产品分类 - CMI_EC_STD_CATEGORY_MAPPING.csv`，灯光类下有**11个二、三级类目**：

| 序号 | stdcategory1 | stdcategory2 | stdcategory3 | 说明 |
|------|--------------|--------------|--------------|------|
| 1 | 灯光类 | COB补光灯 | COB补光灯 | 专业摄影用COB灯，常带保荣口 |
| 2 | 灯光类 | 棒灯 | 棒灯 | 棒状灯管，如PavoTube |
| 3 | 灯光类 | 充气灯 | 充气灯 | 气球灯/充气灯 |
| 4 | 灯光类 | 灯光类-其他 | 灯光类-其他 | 兜底类目 |
| 5 | 灯光类 | 环形灯 | 环形灯 | 环形补光灯 |
| 6 | 灯光类 | 口袋灯 | 口袋灯 | 小型机顶视频灯 |
| 7 | 灯光类 | 平板灯 | 平板灯 | 平板LED灯 |
| 8 | 灯光类 | 闪光灯 | 闪光灯 | 摄影闪光灯/频闪灯 |
| 9 | 灯光类 | 摄影手电 | 摄影手电 | 手电筒类照明设备 |
| 10 | 灯光类 | 手机便携补光灯 | 手机便携补光灯 | 磁吸/夹式手机补光灯 |
| 11 | 灯光类 | 运动相机补光灯 | 运动相机补光灯 | 运动相机专用补光灯 |

---

## 技术架构

### 第一层：文本预处理层

**功能**：将原始商品标题处理为统一的、干净的基础文本

**处理逻辑**：
1. 全角→半角转换（日语商品标题常见全角字符）
2. 大小写归一化（统一小写）
3. 噪声去除（保留字母、数字、连字符、空格）
4. 不翻译（直接处理原语言）

**输入**：`SKU标题`
**输出**：`clean_title`

### 第二层：布尔特征感知层

**功能**：通过关键词匹配，将标题转换为布尔特征向量（0/1）

**特征分类**：

| 特征类型 | 特征示例 | 作用 |
|---------|---------|------|
| 产品形态 | tag_is_ring、tag_is_tube、tag_is_panel | 强形态信号，用于形态锁定 |
| 产品类型 | tag_is_flash、tag_is_cob、tag_is_inflatable | 核心品类信号 |
| 接口规格 | tag_has_bowens、tag_has_magnetic | 区分专业/便携 |
| 配套部件 | tag_has_stand、tag_has_phone_clip | 辅助判断场景 |
| 技术指标 | tag_has_ttl、tag_has_hss、tag_has_rgb | 辅助区分 |

**多语言支持**：
- 每个tag配置CN/US/JP三套关键词
- 同一功能的多语言词映射到同一tag

**示例**：tag_is_ring
```json
{
  "CN": ["环形", "圆环"],
  "US": ["ring light", "ring"],
  "JP": ["リングライト", "リング ライト", "女優ライト", "ledリング"]
}
```

**输出**：布尔特征向量 `{tag_is_ring: 1, tag_has_bowens: 0, ...}`

### 第三层：规格数值归一化层

**功能**：将技术参数提取并归一化到[0, 1]区间

**提取的规格参数**：

| 参数 | 提取模式 | 归一化阈值 | 公式 | 业务意义 |
|------|---------|-----------|------|---------|
| f_wattage | 120W、120w、120ワット | 300W | min(watt/300, 1) | 区分大功率vs便携 |
| f_lux | 5000 lux、5000ルクス | 20000 lux | min(lux/20000, 1) | 照度专业度 |
| f_kelvin | 5600K、5600ケルビン | 10000K | min(kelvin/10000, 1) | 色温参数 |
| f_cri | CRI:96、CRI 96 | 100 | cri/100 | 显色性指标 |

**输出**：数值特征向量 `{f_wattage: 0.4, f_lux: 0.25, ...}`

### 第四层：向量化评分引擎

**数学原理**：
```
Score(品类i) = BaseScore(i) + Σ(特征值 × 权重)
```

**品类配置示例**：

| 品类 | 基础分 | 关键正权重 | 关键负权重 |
|------|--------|-----------|-----------|
| COB补光灯 | 50 | tag_has_bowens: 80<br>tag_is_cob: 60<br>f_wattage: 50 | tag_is_ring: -150<br>tag_is_tube: -120 |
| 环形灯 | 60 | tag_is_ring: 150 | tag_has_bowens: -200<br>tag_is_panel: -150 |
| 运动相机补光灯 | 40 | tag_has_magnetic: 60<br>tag_is_small: 50 | tag_has_bowens: -200 |

**工作流程**：
1. 合并第一、二、三层特征为完整向量
2. 对11个品类并行计算得分
3. 无先后顺序问题（解决SQL"先到先得"问题）

**负权重作用**：
- 解决参数权重过载：即使功率高，形态不对也会被负权重抵消
- 例如：Pano 120c中，tag_is_panel=+100，tag_is_ring=-150

**输出**：11个品类的得分字典

### 第五层：冲突裁决层

**功能**：通过硬规则解决边界情况

**裁决规则优先级（从高到低）**：

| 规则 | 触发条件 | 输出 | 业务场景 |
|------|---------|------|---------|
| 1. 配件拦截 | 标题包含"柔光箱"、"grid"等 | 灯光类-其他 | 配件不属于核心品类 |
| 2. 形态锁定 | tag_is_ring=1 或 tag_is_inflatable=1 | 强制归为对应品类 | 形态明确无需打分 |
| 3. 最低分过滤 | 最高得分 < 30 | 灯光类-其他 | 任何品类都不匹配 |
| 4. 最高分归档 | - | 得分最高的品类 | 常规情况 |

---

## 实施计划

### Phase 0: 项目结构与依赖

**目标**：建立可运行的Python项目结构

**步骤**：
1. 创建标准目录结构
2. 创建`requirements.txt`
3. 创建占位文件

**交付物**：
- 完整的目录树
- 可执行的依赖安装

### Phase 1: 配置文件体系

**目标**：建立完全可配置的分类参数

**1.1 信号词典（`config/signals.json`）**
- 存储11个布尔特征的完整关键词
- 每个tag包含CN/US/JP三套关键词
- 支持后续添加新关键词

**1.2 评分模型（`config/scoring_models.json`）**
- 存储11个品类的完整权重向量
- 包含base_score和所有特征权重
- 支持后续参数调优

**1.3 硬拦截规则（`config/hard_filters.json`）**
- 存储配件词列表、形态锁定规则
- 支持后续扩展拦截规则

### Phase 2: 核心工具模块

**目标**：实现文本预处理和规格提取逻辑

**2.1 文本预处理函数**
- 全角→半角、大小写归一化、噪声去除
- 单元测试覆盖特殊字符

**2.2 规格提取函数**
- 正则匹配4个规格参数
- 归一化处理
- 单元测试覆盖各种格式

**交付物**：
- `src/utils.py`
- `tests/test_utils.py`

### Phase 3: 分类器核心模块

**目标**：实现完整的分类逻辑

**3.1 分类器类设计**
```
class GlobalLightClassifier:
    - __init__: 加载3个配置文件
    - extract_signals: 第二层布尔特征提取
    - extract_specs: 第三层数值特征提取
    - calculate_scores: 第四层向量化评分
    - arbitrate: 第五层冲突裁决
    - process_row: 单行处理入口
    - process: 批量处理入口
```

**交付物**：
- `src/classifier.py`
- `tests/test_classifier.py`

### Phase 4: 主程序入口

**目标**：提供命令行接口，支持批量处理

**功能**：
- 支持CSV/Excel输入
- 支持采样模式
- 输出中间结果
- 进度显示

**命令示例**：
```bash
python main.py --data 日本灯光类.csv --output output.csv
python main.py --data 日本灯光类.csv --sample 1000
```

**交付物**：`main.py`

### Phase 5: 测试用例框架

**目标**：建立典型误判案例的测试集

**测试用例**：

| 案例标题 | 预期分类 | 说明 |
|---------|---------|------|
| amaran Pano 120c 120W RGBWW パネルライト | 平板灯 | 高功率平板灯，不应被功率误判为COB |
| Godox AD300Pro 300W Speedlite ストロボ TTL HSS | 闪光灯 | 高功率闪光灯 |
| NiceVeedi Ring Light 10inch | 环形灯 | 环形灯形态锁定 |
| Ulanzi VL49 Mini Video Light | 口袋灯 | 小型便携灯 |
| Aputure MT Pro 60cm RGBWW | 棒灯 | 棒灯形态 |
| Inflatable Balloon Light 60cm RGB | 充气灯 | 充气灯形态 |

**交付物**：
- `tests/test_cases.json`
- `tests/test_classifier.py`

### Phase 6: 可视化输出

**目标**：输出便于人工核验的中间结果

**输出列设计**：
- `clean_title`: 清洗后标题
- `predicted_category`: 最终分类
- `decision_reason`: 裁决原因
- `scores_all`: 11个品类得分
- `features_bool`: 布尔特征
- `features_num`: 数值特征

---

## 配置文件说明

### config/signals.json

存储11个布尔特征的完整关键词词典。

**结构示例**：
```json
{
  "tag_is_flash": {
    "CN": ["闪光灯", "闪灯"],
    "US": ["flash", "strobe", "speedlite"],
    "JP": ["フラッシュ", "ストロボ", "スピードライト"]
  },
  "tag_is_ring": {
    "CN": ["环形", "圆环"],
    "US": ["ring light", "ring"],
    "JP": ["リングライト", "リング ライト", "女優ライト"]
  }
}
```

### config/scoring_models.json

存储11个品类的评分权重向量。

**结构示例**：
```json
{
  "COB补光灯": {
    "base_score": 50,
    "weights": {
      "tag_has_bowens": 80,
      "tag_is_cob": 60,
      "f_wattage": 50,
      "tag_is_ring": -150,
      "tag_is_tube": -120
    }
  },
  "环形灯": {
    "base_score": 60,
    "weights": {
      "tag_is_ring": 150,
      "tag_has_bowens": -200,
      "tag_is_panel": -150
    }
  }
}
```

### config/hard_filters.json

存储硬拦截规则。

**结构示例**：
```json
{
  "accessories": [
    "softbox", "柔光箱", "ディフューザー",
    "diffuser", "reflector", "リフレクター"
  ],
  "form_factor_lock": {
    "tag_is_ring": "环形灯",
    "tag_is_inflatable": "充气灯"
  }
}
```

---

## 快速开始

### 安装依赖

```bash
cd /Users/chenyu/test
pip install -r requirements.txt
```

### 运行分类

```bash
# 完整数据
python main.py --data 日本灯光类.csv --output data/processed/output.csv

# 快速测试（1000条）
python main.py --data 日本灯光类.csv --sample 1000
```

### 运行测试

```bash
python -m pytest tests/test_classifier.py -v
```

---

## 后续调优方向

### 权重调优
1. 调整`scoring_models.json`中的权重值
2. 基于人工核验结果增加/减少特征权重
3. 新增特征并配置权重

### 关键词扩充
1. 根据人工核验添加新关键词到`signals.json`
2. 新增品牌词（godox、canon、nissin等）
3. 新增型号模式（ad\d+pro、v\d+等）

### 硬拦截规则扩展
1. 发现系统性误判后添加新拦截规则
2. 扩充配件词列表

---

## 附录

### 项目目录结构

```
/Users/chenyu/test/
├── config/
│   ├── signals.json           # 多语言信号词典
│   ├── scoring_models.json   # 品类权重向量
│   └── hard_filters.json     # 硬拦截规则
├── data/
│   ├── raw/
│   │   └── 日本灯光类.csv    # 输入数据
│   ├── processed/            # 处理后数据
│   └── validation/           # 验证结果
├── src/
│   ├── __init__.py
│   ├── classifier.py         # 核心分类器
│   ├── utils.py             # 工具函数
│   └── evaluator.py         # 评估指标
├── tests/
│   ├── test_classifier.py    # 单元测试
│   └── test_cases.json      # 测试用例
├── main.py                 # 主程序入口
├── requirements.txt         # 依赖包
├── CLAUDE.md               # 本文档
├── CMI_EC公司产品分类.csv  # 公司类目映射
└── export.sql              # 原SQL脚本
```

### 关键文件说明

| 文件路径 | 用途 | 可否修改 |
|---------|------|---------|
| config/signals.json | 多语言关键词词典 | ✅ 可配置 |
| config/scoring_models.json | 品类权重向量 | ✅ 可配置 |
| config/hard_filters.json | 硬拦截规则 | ✅ 可配置 |
| src/classifier.py | 分类器核心逻辑 | ❌ 不建议 |
| src/utils.py | 工具函数 | ❌ 不建议 |
| main.py | 主程序入口 | ❌ 不建议 |

---

**文档维护记录**：
- v1.0.0 (2026-02-09): 初始版本，包含完整项目说明
